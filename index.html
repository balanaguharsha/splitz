<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitz - Easy Expense Splitting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Simple transition for modals */
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal.hidden {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="app" class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col p-4 transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0 md:relative z-20">
            <div class="flex justify-between items-center mb-6">
                 <h1 class="text-2xl font-bold text-indigo-600">Splitz</h1>
                 <button id="settings-btn" class="text-gray-500 hover:text-indigo-600"><i class="fas fa-cog text-xl"></i></button>
            </div>
            
            <nav class="flex-grow overflow-y-auto">
                 <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Navigation</h2>
                <ul id="friends-list" class="mb-6">
                    <!-- Friends will be dynamically inserted here -->
                </ul>
                <button id="add-friend-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium mb-6"><i class="fas fa-user-plus mr-2"></i>Add Friend</button>

                <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Data Management</h2>
                <div class="space-y-2">
                    <button id="export-btn" class="w-full text-sm flex items-center justify-center bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition"><i class="fas fa-file-export mr-2"></i>Export Data</button>
                    <button id="import-btn" class="w-full text-sm flex items-center justify-center bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition"><i class="fas fa-file-import mr-2"></i>Import Data</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
            </nav>

            <div class="text-xs text-gray-400 mt-4">
                <p>&copy; 2025 Splitz</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b border-gray-200 flex items-center justify-between p-4 flex-shrink-0">
                <button id="menu-toggle" class="md:hidden text-gray-600 focus:outline-none z-30">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 id="main-header" class="text-xl font-semibold">Dashboard</h2>
                <button id="settle-up-header-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">Settle Up</button>
            </header>

            <div class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-4 sm:p-6">
                 <!-- UPDATED: QUICK ADD FORM is now always visible -->
                <div id="quick-add-form-container" class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 border-b pb-2">Add a New Expense</h3>
                    <form id="quick-add-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <input type="text" id="qa-description" placeholder="Description" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                                <input type="number" id="qa-amount" min="0.01" step="0.01" class="w-full border-gray-300 rounded-lg shadow-sm pl-7" placeholder="Amount" required>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                             <div>
                                <label for="qa-paid-by" class="block text-sm font-medium text-gray-700 mb-1">Paid by</label>
                                <select id="qa-paid-by" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                            </div>
                            <div class="flex justify-end">
                                 <button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Add Expense</button>
                            </div>
                        </div>
                        <div class="mt-4">
                             <p class="block text-sm font-medium text-gray-700 mb-2">Split with</p>
                             <div id="qa-participants-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-x-4 gap-y-2">
                                <!-- Participant checkboxes will be dynamically inserted here -->
                             </div>
                        </div>
                    </form>
                </div>
                <!-- END QUICK ADD FORM -->

                <div id="dashboard-view">
                    <h3 class="text-lg font-semibold mb-4">Overall Balances</h3>
                    <div id="overall-balances" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Balance cards will be dynamically inserted here -->
                    </div>
                    <h3 class="text-lg font-semibold mt-8 mb-4">Simplified Debts</h3>
                    <div id="simplified-debts" class="bg-white p-4 rounded-lg shadow-sm">
                        <!-- Simplified debt list will be inserted here -->
                    </div>
                </div>

                <div id="friend-view" class="hidden">
                    <div id="expense-list-container">
                        <!-- Expenses for a friend will be listed here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS START HERE -->

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-semibold mb-4">Settings</h3>
            <form id="settings-form">
                <div class="mb-4">
                    <label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                    <input type="text" id="user-name" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Friend Modal -->
    <div id="add-friend-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-semibold mb-4">Add a New Friend</h3>
            <form id="add-friend-form">
                <div class="mb-4">
                    <label for="friend-name" class="block text-sm font-medium text-gray-700 mb-1">Friend's Name</label>
                    <input type="text" id="friend-name" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add Friend</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Settle Up Modal -->
    <div id="settle-up-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-semibold mb-4">Settle Up</h3>
            <form id="settle-up-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">From</label>
                    <select id="settle-from" class="w-full border-gray-300 rounded-lg shadow-sm"></select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">To</label>
                    <select id="settle-to" class="w-full border-gray-300 rounded-lg shadow-sm"></select>
                </div>
                 <div class="mb-6">
                    <label for="settle-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                     <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₹</span>
                        <input type="number" id="settle-amount" min="0.01" step="0.01" class="w-full border-gray-300 rounded-lg shadow-sm pl-7" placeholder="0.00" required>
                    </div>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <i id="confirm-modal-icon" class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
            <h3 id="confirm-modal-title" class="text-xl font-semibold mb-2">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirm-modal-confirm" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- STATE MANAGEMENT ---
        let state = {
            friends: [],
            expenses: [],
            currentView: { type: 'dashboard', id: null }
        };

        // --- DOM ELEMENTS ---
        const DOMElements = {
            app: document.getElementById('app'),
            sidebar: document.getElementById('sidebar'),
            menuToggle: document.getElementById('menu-toggle'),
            friendsList: document.getElementById('friends-list'),
            mainHeader: document.getElementById('main-header'),
            dashboardView: document.getElementById('dashboard-view'),
            friendView: document.getElementById('friend-view'),
            overallBalances: document.getElementById('overall-balances'),
            simplifiedDebts: document.getElementById('simplified-debts'),
            expenseListContainer: document.getElementById('expense-list-container'),
            
            // Modals
            settingsModal: document.getElementById('settings-modal'),
            addFriendModal: document.getElementById('add-friend-modal'),
            settleUpModal: document.getElementById('settle-up-modal'),
            confirmModal: document.getElementById('confirm-modal'),

            // Forms
            settingsForm: document.getElementById('settings-form'),
            addFriendForm: document.getElementById('add-friend-form'),
            settleUpForm: document.getElementById('settle-up-form'),
            quickAddFormContainer: document.getElementById('quick-add-form-container'),
            quickAddForm: document.getElementById('quick-add-form'),

            // Buttons
            settingsBtn: document.getElementById('settings-btn'),
            addFriendBtn: document.getElementById('add-friend-btn'),
            settleUpHeaderBtn: document.getElementById('settle-up-header-btn'),
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            importFileInput: document.getElementById('import-file-input'),

            // Modal Controls
            modalCancelBtns: document.querySelectorAll('.modal-cancel-btn'),
            confirmModalCancel: document.getElementById('confirm-modal-cancel'),
            confirmModalConfirm: document.getElementById('confirm-modal-confirm'),
        };
        
        // --- LOCAL STORAGE ---
        const storageKey = 'splitwiseCloneDataManual';

        function saveData() {
            localStorage.setItem(storageKey, JSON.stringify(state));
        }

        function loadData() {
            const data = localStorage.getItem(storageKey);
            if (data) {
                state = JSON.parse(data);
                if (!state.friends.some(f => f.isYou)) {
                    state.friends.unshift({ id: crypto.randomUUID(), name: 'You', isYou: true });
                }
            } else {
                state = {
                    friends: [{ id: crypto.randomUUID(), name: 'You', isYou: true }],
                    expenses: [],
                    currentView: { type: 'dashboard', id: null }
                };
            }
            saveData();
        }
        
        // --- UTILITY FUNCTIONS ---
        const findFriend = (id) => state.friends.find(f => f.id === id);
        const findFriendByName = (name) => {
            if (!name) return null;
            return state.friends.find(f => f.name.toLowerCase() === name.toLowerCase());
        }
        const getYou = () => state.friends.find(f => f.isYou);
        
        const formatCurrency = (amount) => {
            const absAmount = Math.abs(amount).toFixed(2);
            return amount < 0 ? `-₹${absAmount}` : `₹${absAmount}`;
        };

        // --- CONFIRMATION MODAL LOGIC ---
        let confirmCallback = null;
        function showConfirmModal({ title, text, confirmText, iconClass, onConfirm }) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;
            document.getElementById('confirm-modal-confirm').textContent = confirmText;
            const icon = document.getElementById('confirm-modal-icon');
            icon.className = iconClass; 

            const confirmButton = DOMElements.confirmModalConfirm;
            confirmButton.className = "px-6 py-2 rounded-lg";
            const color = iconClass.match(/text-(\w+)-/)[1];
            confirmButton.classList.add(`bg-${color}-600`, `hover:bg-${color}-700`, 'text-white');

            confirmCallback = onConfirm;
            showModal(DOMElements.confirmModal);
        }

        DOMElements.confirmModalConfirm.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
            hideModal(DOMElements.confirmModal);
        });

        // --- MODAL HANDLING ---
        function showModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0', 'transform', 'scale-95'), 10);
        }

        function hideModal(modal) {
            modal.classList.add('opacity-0', 'transform', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        DOMElements.modalCancelBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                hideModal(btn.closest('.modal'));
            });
        });
        DOMElements.confirmModalCancel.addEventListener('click', () => hideModal(DOMElements.confirmModal));

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderFriendsList();
            renderCurrentView();
        }

        function renderFriendsList() {
            DOMElements.friendsList.innerHTML = '';
            const dashboardItem = document.createElement('li');
            dashboardItem.innerHTML = `<a href="#" data-view-type="dashboard" class="flex items-center p-2 rounded-lg hover:bg-gray-100 font-medium">
                <i class="fas fa-tachometer-alt w-6 text-center text-gray-500 mr-3"></i> Dashboard</a>`;
            if (state.currentView.type === 'dashboard') {
                dashboardItem.querySelector('a').classList.add('bg-indigo-100', 'text-indigo-700');
            }
            DOMElements.friendsList.appendChild(dashboardItem);

            state.friends.forEach(friend => {
                if (friend.isYou) return;
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" data-view-type="friend" data-friend-id="${friend.id}" class="flex items-center p-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-user w-6 text-center text-gray-500 mr-3"></i> ${friend.name}</a>`;
                if (state.currentView.type === 'friend' && state.currentView.id === friend.id) {
                    li.querySelector('a').classList.add('bg-indigo-100', 'text-indigo-700');
                }
                DOMElements.friendsList.appendChild(li);
            });
        }
        
        function renderCurrentView() {
            if (state.currentView.type === 'dashboard') {
                DOMElements.mainHeader.textContent = 'Dashboard';
                DOMElements.dashboardView.classList.remove('hidden');
                DOMElements.friendView.classList.add('hidden');
                DOMElements.quickAddFormContainer.classList.remove('hidden');
                renderDashboard();
            } else if (state.currentView.type === 'friend') {
                const friend = findFriend(state.currentView.id);
                if (!friend) { 
                    state.currentView = { type: 'dashboard', id: null };
                    renderCurrentView();
                    return;
                }
                DOMElements.mainHeader.textContent = `Expenses with ${friend.name}`;
                DOMElements.dashboardView.classList.add('hidden');
                DOMElements.friendView.classList.remove('hidden');
                DOMElements.quickAddFormContainer.classList.add('hidden');
                renderFriendView(friend.id);
            }
        }

        function renderDashboard() {
            const balances = calculateBalances();
            renderOverallBalanceCards(balances);
            renderSimplifiedDebts(balances);
        }

        function renderFriendView(friendId) {
            const youId = getYou().id;
            const relevantExpenses = state.expenses.filter(e => 
                e.participants.includes(friendId) && e.participants.includes(youId)
            );
            
            DOMElements.expenseListContainer.innerHTML = '';

            if (relevantExpenses.length === 0) {
                 DOMElements.expenseListContainer.innerHTML = `<div class="text-center py-12 bg-white rounded-lg shadow-sm">
                    <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700">No expenses yet</h3>
                    <p class="text-gray-500 mt-2">Add an expense with ${findFriend(friendId).name} to get started.</p>
                </div>`;
                return;
            }

            relevantExpenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                const expenseEl = createExpenseElement(expense, youId);
                DOMElements.expenseListContainer.appendChild(expenseEl);
            });
        }

        function createExpenseElement(expense, currentUserId) {
            const el = document.createElement('div');
            el.className = 'bg-white p-4 rounded-lg shadow-sm mb-3 flex items-start';
            
            const paidByFriend = findFriend(expense.paidBy);
            const userShare = expense.split.find(s => s.friendId === currentUserId)?.amount || 0;
            let shareText = '';
            
            const payerName = paidByFriend ? paidByFriend.name : 'A deleted user';

            if (expense.paidBy === currentUserId) {
                const lentAmount = expense.amount - userShare;
                shareText = `<span class="text-green-600 font-semibold">You lent ${formatCurrency(lentAmount)}</span>`;
            } else {
                if (userShare > 0) {
                    shareText = `<span class="text-red-600 font-semibold">You borrowed ${formatCurrency(userShare)}</span>`;
                } else {
                    shareText = `<span class="text-gray-500">Not involved in split</span>`;
                }
            }
            
            el.innerHTML = `
                <div class="text-sm text-center mr-4 flex-shrink-0 w-14">
                    <div class="font-bold text-gray-700">${new Date(expense.date).toLocaleString('default', { month: 'short' })}</div>
                    <div class="text-2xl font-light text-gray-500">${new Date(expense.date).getDate()}</div>
                </div>
                <div class="flex-grow">
                    <p class="font-semibold">${expense.description}</p>
                    <p class="text-sm text-gray-500">${payerName} paid ${formatCurrency(expense.amount)}</p>
                    <p class="text-sm">${shareText}</p>
                </div>
                <button class="delete-expense-btn text-gray-400 hover:text-red-500 transition" data-expense-id="${expense.id}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            return el;
        }

        function renderOverallBalanceCards(balances) {
            DOMElements.overallBalances.innerHTML = '';
            const you = getYou();
            if (!you) return;
            const youBalance = balances[you.id] || 0;
            
            let totalOwedToYou = 0;
            let totalYouOwe = 0;

            const simplified = simplifyDebts(balances);
            simplified.forEach(({ from, to, amount }) => {
                const fromFriend = findFriend(from);
                const toFriend = findFriend(to);
                if(!fromFriend || !toFriend) return;
                
                if (to === you.id) totalOwedToYou += amount;
                if (from === you.id) totalYouOwe += amount;
            });

            const cardData = [
                { title: 'You are owed', amount: totalOwedToYou, color: 'green' },
                { title: 'You owe', amount: totalYouOwe, color: 'red' },
                { title: 'Total balance', amount: youBalance, color: youBalance >= 0 ? 'blue' : 'red' },
            ];
            
            cardData.forEach(data => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-lg shadow-sm border-l-4 border-${data.color}-500`;
                card.innerHTML = `
                    <h4 class="text-sm text-gray-500 font-medium">${data.title}</h4>
                    <p class="text-2xl font-semibold text-gray-800">${formatCurrency(data.amount)}</p>
                `;
                DOMElements.overallBalances.appendChild(card);
            });
        }
        
        function renderSimplifiedDebts(balances) {
            DOMElements.simplifiedDebts.innerHTML = '';
            const simplified = simplifyDebts(balances);
            if (simplified.length === 0) {
                DOMElements.simplifiedDebts.innerHTML = `<div class="text-center py-8">
                    <i class="fas fa-check-circle text-3xl text-green-400 mb-3"></i>
                    <p class="font-semibold text-gray-700">You are all settled up!</p>
                </div>`;
                return;
            }

            const list = document.createElement('ul');
            list.className = 'space-y-3';
            simplified.forEach(({ from, to, amount }) => {
                const fromFriend = findFriend(from);
                const toFriend = findFriend(to);
                if (!fromFriend || !toFriend) return;

                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 rounded-md bg-gray-50';
                li.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-semibold text-gray-800">${fromFriend.name}</span>
                        <i class="fas fa-arrow-right text-sm text-gray-400 mx-3"></i>
                        <span class="font-semibold text-gray-800">${toFriend.name}</span>
                    </div>
                    <span class="font-bold text-lg text-indigo-600">${formatCurrency(amount)}</span>
                `;
                list.appendChild(li);
            });
            
            DOMElements.simplifiedDebts.appendChild(list);
        }

        // --- CALCULATION LOGIC ---
        function calculateBalances() {
            const balances = {};
            state.friends.forEach(f => balances[f.id] = 0);

            state.expenses.forEach(expense => {
                const payerId = expense.paidBy;
                const totalAmount = expense.amount;
                
                if(balances[payerId] !== undefined) balances[payerId] += totalAmount;

                expense.split.forEach(split => {
                    if(balances[split.friendId] !== undefined) balances[split.friendId] -= split.amount;
                });
            });
            return balances;
        }

        function simplifyDebts(balances) {
            const participants = Object.entries(balances)
                .map(([id, amount]) => ({ id, amount }))
                .filter(p => Math.abs(p.amount) > 0.01);

            const debtors = participants.filter(p => p.amount < 0).map(p => ({...p, amount: -p.amount}));
            const creditors = participants.filter(p => p.amount > 0);

            const settlements = [];

            while (debtors.length > 0 && creditors.length > 0) {
                debtors.sort((a,b) => b.amount - a.amount);
                creditors.sort((a,b) => b.amount - a.amount);

                const debtor = debtors[0];
                const creditor = creditors[0];
                const amount = Math.min(debtor.amount, creditor.amount);

                settlements.push({ from: debtor.id, to: creditor.id, amount });

                debtor.amount -= amount;
                creditor.amount -= amount;

                if (debtor.amount < 0.01) debtors.shift();
                if (creditor.amount < 0.01) creditors.shift();
            }
            return settlements;
        }

        // --- EVENT HANDLERS & LOGIC ---

        // Setup Quick Add Form
        function setupQuickAddForm() {
            const you = getYou();
            const paidBySelect = document.getElementById('qa-paid-by');
            paidBySelect.innerHTML = '';
            state.friends.forEach(f => {
                const option = new Option(f.name, f.id);
                if (f.isYou) {
                    option.selected = true;
                }
                paidBySelect.appendChild(option);
            });

            const participantsList = document.getElementById('qa-participants-list');
            participantsList.innerHTML = '';
            state.friends.forEach(f => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                const checkboxId = `qa-friend-${f.id}`;
                div.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" data-friend-id="${f.id}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 participant-checkbox" checked>
                    <label for="${checkboxId}" class="ml-2 block text-sm text-gray-900">${f.name}</label>
                `;
                participantsList.appendChild(div);
            });
        }

        // Handle Quick Add Form Submission
        DOMElements.quickAddForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const description = document.getElementById('qa-description').value.trim();
            const amount = parseFloat(document.getElementById('qa-amount').value);
            const paidBy = document.getElementById('qa-paid-by').value;
            
            const checkedBoxes = document.querySelectorAll('#qa-participants-list .participant-checkbox:checked');
            const participants = Array.from(checkedBoxes).map(cb => cb.dataset.friendId);
            
            if (!description || !amount || !paidBy || participants.length === 0) {
                alert('Please fill out all fields and select at least one person to split with.');
                return;
            }

            const share = amount / participants.length;
            const split = participants.map(id => ({ friendId: id, amount: share }));

            const newExpense = {
                id: crypto.randomUUID(),
                description, amount, paidBy,
                date: new Date().toISOString(),
                participants,
                split
            };

            state.expenses.push(newExpense);
            saveData();
            
            // Clear form for next entry, but keep defaults
            document.getElementById('qa-description').value = '';
            document.getElementById('qa-amount').value = '';
            // Reset participants to all checked
            document.querySelectorAll('#qa-participants-list .participant-checkbox').forEach(cb => {
                cb.checked = true;
            });
            document.getElementById('qa-description').focus();
            
            renderAll();
        });


        // Settings Modal
        DOMElements.settingsBtn.addEventListener('click', () => {
            const you = getYou();
            document.getElementById('user-name').value = you.name;
            showModal(DOMElements.settingsModal);
        });

        DOMElements.settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = document.getElementById('user-name').value.trim();
            if (newName) {
                getYou().name = newName;
                saveData();
                renderAll();
                setupQuickAddForm(); // Refresh quick add form with new user name
                hideModal(DOMElements.settingsModal);
            }
        });

        // View Switching
        DOMElements.friendsList.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();
            const viewType = link.dataset.viewType;
            const friendId = link.dataset.friendId || null;
            state.currentView = { type: viewType, id: friendId };
            renderAll();
            if(window.innerWidth < 768) {
                DOMElements.sidebar.classList.add('-translate-x-full');
            }
        });

        // Add Friend Modal
        DOMElements.addFriendBtn.addEventListener('click', () => {
            DOMElements.addFriendForm.reset();
            showModal(DOMElements.addFriendModal);
            document.getElementById('friend-name').focus();
        });

        DOMElements.addFriendForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('friend-name').value.trim();
            if (name && !findFriendByName(name)) {
                state.friends.push({ id: crypto.randomUUID(), name, isYou: false });
                saveData();
                renderFriendsList();
                setupQuickAddForm(); // Refresh quick add form with new friend
                hideModal(DOMElements.addFriendModal);
            } else if (findFriendByName(name)) {
                alert("A friend with this name already exists.");
            }
        });
        
        // Delete Expense
        DOMElements.app.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-expense-btn');
            if (deleteBtn) {
                const expenseId = deleteBtn.dataset.expenseId;
                showConfirmModal({
                    title: "Delete Expense?",
                    text: "This will permanently remove this expense. This action cannot be undone.",
                    confirmText: "Delete",
                    iconClass: "fas fa-trash-alt text-4xl text-red-500 mb-4",
                    onConfirm: () => {
                        state.expenses = state.expenses.filter(ex => ex.id !== expenseId);
                        saveData();
                        renderCurrentView();
                    }
                });
            }
        });
        
        // Settle Up Modal
        function openSettleUpModal() {
            DOMElements.settleUpForm.reset();
            const fromSelect = document.getElementById('settle-from');
            const toSelect = document.getElementById('settle-to');
            fromSelect.innerHTML = '';
            toSelect.innerHTML = '';
            
            state.friends.forEach(f => {
                fromSelect.add(new Option(f.name, f.id));
                toSelect.add(new Option(f.name, f.id));
            });
            showModal(DOMElements.settleUpModal);
        }

        DOMElements.settleUpHeaderBtn.addEventListener('click', openSettleUpModal);

        DOMElements.settleUpForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const fromId = document.getElementById('settle-from').value;
            const toId = document.getElementById('settle-to').value;
            const amount = parseFloat(document.getElementById('settle-amount').value);

            if (fromId === toId || !amount) {
                alert("Please select two different people and enter an amount.");
                return;
            }

            const paymentExpense = {
                id: crypto.randomUUID(),
                description: `Payment from ${findFriend(fromId).name} to ${findFriend(toId).name}`,
                amount: amount,
                paidBy: fromId,
                date: new Date().toISOString(),
                participants: [fromId, toId],
                split: [{ friendId: toId, amount: amount }]
            };

            state.expenses.push(paymentExpense);
            saveData();
            renderAll();
            hideModal(DOMElements.settleUpModal);
        });
        
        // Data Import/Export
        DOMElements.exportBtn.addEventListener('click', () => {
            const dataStr = JSON.stringify(state, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `splitz_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        DOMElements.importBtn.addEventListener('click', () => {
            DOMElements.importFileInput.click();
        });

        DOMElements.importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedState = JSON.parse(event.target.result);
                    if (importedState.friends && importedState.expenses) {
                         showConfirmModal({
                            title: "Import Data?",
                            text: "This will overwrite all your current data. Are you sure you want to proceed?",
                            confirmText: "Import",
                            iconClass: "fas fa-file-import text-4xl text-indigo-500 mb-4",
                            onConfirm: () => {
                                state = importedState;
                                if (!state.friends.some(f => f.isYou)) {
                                    state.friends.unshift({ id: crypto.randomUUID(), name: 'You', isYou: true });
                                }
                                saveData();
                                renderAll();
                                setupQuickAddForm(); // Refresh form after import
                            }
                        });
                    } else {
                        alert("Invalid data file format.");
                    }
                } catch (error) {
                    alert("Error reading file. Please make sure it's a valid JSON backup file.");
                    console.error("Import error:", error);
                } finally {
                    e.target.value = '';
                }
            };
            reader.readAsText(file);
        });

        // Responsive Sidebar
        DOMElements.menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            DOMElements.sidebar.classList.toggle('-translate-x-full');
        });

        DOMElements.app.addEventListener('click', (e) => {
             if (window.innerWidth < 768 && !DOMElements.sidebar.contains(e.target) && !DOMElements.menuToggle.contains(e.target)) {
                 DOMElements.sidebar.classList.add('-translate-x-full');
             }
        })
        
        // --- INITIALIZATION ---
        function init() {
            loadData();
            renderAll();
            setupQuickAddForm();
        }

        init();
    });
    </script>
</body>
</html>
